<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>JSON output vs. schema-validated output in LLMR • LLMR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="JSON output vs. schema-validated output in LLMR">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">LLMR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/asanaei/LLMR"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>JSON output vs. schema-validated output in LLMR</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/asanaei/LLMR/blob/main/vignettes/about-schema.Rmd" class="external-link"><code>vignettes/about-schema.Rmd</code></a></small>
      <div class="d-none name"><code>about-schema.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span></span>
<span>  collapse <span class="op">=</span> <span class="cn">TRUE</span>, comment <span class="op">=</span> <span class="st">"#&gt;"</span>,</span>
<span>  eval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"LLMR_RUN_VIGNETTES"</span>, <span class="st">"false"</span><span class="op">)</span><span class="op">)</span>, <span class="st">"true"</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="tldr">TL;DR<a class="anchor" aria-label="anchor" href="#tldr"></a>
</h2>
<ul>
<li>
<strong>JSON mode</strong>: ask the model for “a JSON object.” Lower
friction. Weak guarantees.<br>
</li>
<li>
<strong>Schema output</strong>: give a JSON Schema and request
strict validation. Higher reliability <em>when the provider enforces
it</em>.<br>
</li>
<li>
<strong>Reality</strong>: enforcement and request shapes differ
across providers. Use <strong>defensive parsing</strong> and
<strong>local validation</strong>.</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="what-the-major-providers-actually-support">What the major providers actually support<a class="anchor" aria-label="anchor" href="#what-the-major-providers-actually-support"></a>
</h2>
<ul>
<li><p><strong>OpenAI-compatible (OpenAI, Groq, Together, x.ai,
DeepSeek)</strong><br>
Chat Completions accept a <code>response_format</code> (e.g.,
<code>{"type":"json_object"}</code> or a JSON-Schema payload).
Enforcement varies by provider but the interface is OpenAI-shaped.<br>
See <a href="https://platform.openai.com/docs/guides/structured-outputs" class="external-link">OpenAI
API overview</a>, <a href="https://console.groq.com/docs/structured-outputs" class="external-link">Groq API
(OpenAI-compatible)</a>, <a href="https://docs.together.ai/docs/json-mode" class="external-link">Together: OpenAI
compatibility</a>, <a href="https://docs.x.ai/docs/guides/structured-outputs" class="external-link">x.ai: OpenAI API
schema</a>, <a href="https://api-docs.deepseek.com/guides/json_mode" class="external-link">DeepSeek:
OpenAI-compatible endpoint</a></p></li>
<li><p><strong>Anthropic (Claude)</strong><br>
No global “JSON mode.” Instead, you <strong>define a tool</strong> with
an <strong><code>input_schema</code></strong> (JSON Schema) and
<strong>force</strong> it via <code>tool_choice</code>, so the model
must return a JSON object that validates the schema.<br>
See <a href="https://docs.anthropic.com/en/api/messages#tools" class="external-link">Anthropic
Messages API: tools &amp; <code>input_schema</code></a></p></li>
<li><p><strong>Google Gemini (REST)</strong><br>
Set <code>responseMimeType = "application/json"</code> in
<code>generationConfig</code> to request JSON. Some models also accept
<strong><code>responseSchema</code></strong> for constrained JSON
(model-dependent).<br>
See <a href="https://ai.google.dev/gemini-api/docs/" class="external-link">Gemini
documentation</a> —</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="why-prefer-schema-output">Why prefer schema output?<a class="anchor" aria-label="anchor" href="#why-prefer-schema-output"></a>
</h2>
<ul>
<li>
<strong>Deterministic downstream code</strong>: predictable
keys/types enable typed transforms.<br>
</li>
<li>
<strong>Safer integrations</strong>: strict mode avoids extra keys,
missing fields, or textual preambles.<br>
</li>
<li>
<strong>Faster failure</strong>: invalid generations fail early,
where retry/backoff is easy to manage.</li>
</ul>
</div>
<div class="section level2">
<h2 id="why-json-only-still-matters">Why JSON-only still matters<a class="anchor" aria-label="anchor" href="#why-json-only-still-matters"></a>
</h2>
<ul>
<li>
<strong>Broadest support</strong> across
models/providers/proxies.<br>
</li>
<li>
<strong>Low ceremony</strong> for exploration, labeling, and quick
prototypes.</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="quirks-you-will-hit-in-practice">Quirks you will hit in practice<a class="anchor" aria-label="anchor" href="#quirks-you-will-hit-in-practice"></a>
</h2>
<ul>
<li>Models often wrap JSON in <strong>code fences</strong> or add
pre/post text.<br>
</li>
<li>Arrays/objects appear where you expected scalars; <strong>ints vs
doubles</strong> vary by provider/sample.<br>
</li>
<li>
<strong>Safety/length caps</strong> can truncate output; detect and
handle “finish_reason = length/filter.”</li>
</ul>
<div class="section level3">
<h3 id="llmr-helpers-to-blunt-those-edges">LLMR helpers to blunt those edges<a class="anchor" aria-label="anchor" href="#llmr-helpers-to-blunt-those-edges"></a>
</h3>
<ul>
<li>
<code><a href="../reference/llm_parse_structured.html">llm_parse_structured()</a></code> strips fences and extracts the
<strong>largest balanced</strong> <code>{...}</code> or
<code>[...]</code> before parsing.<br>
</li>
<li>
<code><a href="../reference/llm_parse_structured_col.html">llm_parse_structured_col()</a></code> hoists fields (supports
dot/bracket paths and JSON Pointer) and keeps non-scalars as
list-columns.<br>
</li>
<li>
<code><a href="../reference/llm_validate_structured_col.html">llm_validate_structured_col()</a></code> validates locally via
<strong>jsonvalidate (AJV)</strong>.<br>
</li>
<li>
<code><a href="../reference/enable_structured_output.html">enable_structured_output()</a></code> flips the right provider
switch (OpenAI-compat <code>response_format</code>, Anthropic
<strong>tool + <code>input_schema</code></strong>, Gemini
<code>responseMimeType</code>/<code>responseSchema</code>).</li>
</ul>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="minimal-patterns-guarded-code">Minimal patterns (guarded code)<a class="anchor" aria-label="anchor" href="#minimal-patterns-guarded-code"></a>
</h2>
<p>All chunks use a tiny helper so your document <strong>knits even
without API keys</strong>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">safe</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="va">expr</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"ERROR: "</span>, <span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span>; <span class="cn">NULL</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="json-mode-no-schema-works-across-openai-compatible-providers">1) JSON mode, no schema (works across OpenAI-compatible
providers)<a class="anchor" aria-label="anchor" href="#json-mode-no-schema-works-across-openai-compatible-providers"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/asanaei/LLMR" class="external-link">LLMR</a></span><span class="op">)</span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_config.html">llm_config</a></span><span class="op">(</span></span>
<span>    provider <span class="op">=</span> <span class="st">"openai"</span>,                <span class="co"># try "groq" or "together" too</span></span>
<span>    model    <span class="op">=</span> <span class="st">"gpt-4o-mini"</span>,</span>
<span>    temperature <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Flip JSON mode on (OpenAI-compat shape)</span></span>
<span>  <span class="va">cfg_json</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enable_structured_output.html">enable_structured_output</a></span><span class="op">(</span><span class="va">cfg</span>, schema <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res</span>    <span class="op">&lt;-</span> <span class="fu"><a href="../reference/call_llm.html">call_llm</a></span><span class="op">(</span><span class="va">cfg_json</span>, <span class="st">'Give me a JSON object {"ok": true, "n": 3}.'</span><span class="op">)</span></span>
<span>  <span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_parse_structured.html">llm_parse_structured</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Raw text:\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><strong>What could still fail?</strong> Proxies labeled
“OpenAI-compatible” sometimes accept <code>response_format</code> but
don’t strictly enforce it; LLMR’s parser recovers from fences or
pre/post text.</p>
<hr>
</div>
<div class="section level3">
<h3 id="schema-mode-that-actually-works-groq-qwen-open-weights-non-commercial-friendly">2) <strong>Schema mode that actually works</strong> (Groq + Qwen,
<em>open-weights / non-commercial friendly</em>)<a class="anchor" aria-label="anchor" href="#schema-mode-that-actually-works-groq-qwen-open-weights-non-commercial-friendly"></a>
</h3>
<p>Groq serves Qwen 2.5 Instruct models with OpenAI-compatible APIs.
Their <strong>Structured Outputs</strong> feature enforces JSON Schema
and (notably) expects <strong>all properties to be listed under
<code>required</code></strong>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/asanaei/LLMR" class="external-link">LLMR</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Schema: make every property required to satisfy Groq's stricter check</span></span>
<span>  <span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"object"</span>,</span>
<span>    additionalProperties <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"string"</span><span class="op">)</span>,</span>
<span>      year  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"integer"</span><span class="op">)</span>,</span>
<span>      tags  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"array"</span>, items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"string"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    required <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"title"</span>,<span class="st">"year"</span>,<span class="st">"tags"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_config.html">llm_config</a></span><span class="op">(</span></span>
<span>    provider <span class="op">=</span> <span class="st">"groq"</span>,</span>
<span>    model    <span class="op">=</span> <span class="st">"qwen-2.5-72b-instruct"</span>,   <span class="co"># a Qwen Instruct model on Groq</span></span>
<span>    temperature <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">cfg_strict</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enable_structured_output.html">enable_structured_output</a></span><span class="op">(</span><span class="va">cfg</span>, schema <span class="op">=</span> <span class="va">schema</span>, strict <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">df</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BERT paper"</span>, <span class="st">"Vision Transformers"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_fn_structured.html">llm_fn_structured</a></span><span class="op">(</span></span>
<span>    <span class="va">df</span>,</span>
<span>    prompt   <span class="op">=</span> <span class="st">"Return JSON about '{x}' with fields title, year, tags."</span>,</span>
<span>    .config  <span class="op">=</span> <span class="va">cfg_strict</span>,</span>
<span>    .schema  <span class="op">=</span> <span class="va">schema</span>,          <span class="co"># send schema to provider</span></span>
<span>    .fields  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"title"</span>,<span class="st">"year"</span>,<span class="st">"tags"</span><span class="op">)</span>,</span>
<span>    .validate_local <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">structured_ok</span>, <span class="va">structured_valid</span>, <span class="va">title</span>, <span class="va">year</span>, <span class="va">tags</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If your key is set, you should see <code>structured_ok = TRUE</code>,
<code>structured_valid = TRUE</code>, plus parsed columns. <em>(Tip: if
you see a 400 complaining about <code>required</code>, add
<strong>all</strong> properties to <code>required</code>, as
above.)</em></p>
<hr>
</div>
<div class="section level3">
<h3 id="anthropic-force-a-schema-via-a-tool-may-require-max_tokens">3) Anthropic: force a schema via a tool (may require
<code>max_tokens</code>)<a class="anchor" aria-label="anchor" href="#anthropic-force-a-schema-via-a-tool-may-require-max_tokens"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/asanaei/LLMR" class="external-link">LLMR</a></span><span class="op">)</span></span>
<span>  <span class="va">schema</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    type<span class="op">=</span><span class="st">"object"</span>,</span>
<span>    properties<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>answer<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"string"</span><span class="op">)</span>, confidence<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type<span class="op">=</span><span class="st">"number"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    required<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"answer"</span>,<span class="st">"confidence"</span><span class="op">)</span>,</span>
<span>    additionalProperties<span class="op">=</span><span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_config.html">llm_config</a></span><span class="op">(</span><span class="st">"anthropic"</span>,<span class="st">"claude-3-7"</span>, temperature <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enable_structured_output.html">enable_structured_output</a></span><span class="op">(</span><span class="va">cfg</span>, schema <span class="op">=</span> <span class="va">schema</span>, name <span class="op">=</span> <span class="st">"llmr_schema"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/call_llm.html">call_llm</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    system <span class="op">=</span> <span class="st">"Return only the tool result that matches the schema."</span>,</span>
<span>    user   <span class="op">=</span> <span class="st">"Answer: capital of Japan; include confidence in [0,1]."</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_parse_structured.html">llm_parse_structured</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Anthropic <em>requires</em> <code>max_tokens</code>; LLMR warns and
defaults if you omit it.</p>
</blockquote>
<hr>
</div>
<div class="section level3">
<h3 id="gemini-json-response-plus-optional-response-schema-on-supported-models">4) Gemini: JSON response (plus optional response schema on supported
models)<a class="anchor" aria-label="anchor" href="#gemini-json-response-plus-optional-response-schema-on-supported-models"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/asanaei/LLMR" class="external-link">LLMR</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cfg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_config.html">llm_config</a></span><span class="op">(</span></span>
<span>    <span class="st">"gemini"</span>, <span class="st">"gemini-2.0-flash"</span>,</span>
<span>    response_mime_type <span class="op">=</span> <span class="st">"application/json"</span>  <span class="co"># ask for JSON back</span></span>
<span>    <span class="co"># Optionally: gemini_enable_response_schema = TRUE, response_schema = &lt;your JSON Schema&gt;</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/call_llm.html">call_llm</a></span><span class="op">(</span><span class="va">cfg</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    system <span class="op">=</span> <span class="st">"Reply as JSON only."</span>,</span>
<span>    user   <span class="op">=</span> <span class="st">"Produce fields name and score about 'MNIST'."</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/llm_parse_structured.html">llm_parse_structured</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="defensive-patterns-no-api-calls">Defensive patterns (no API calls)<a class="anchor" aria-label="anchor" href="#defensive-patterns-no-api-calls"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">safe</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/asanaei/LLMR" class="external-link">LLMR</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">messy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'```json\n{"x": 1, "y": [1,2,3]}\n```'</span>,</span>
<span>    <span class="st">'Sure! Here is JSON: {"x":"1","y":"oops"} trailing words'</span>,</span>
<span>    <span class="st">'{"x":1, "y":[2,3,4]}'</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>response_text <span class="op">=</span> <span class="va">messy</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/llm_parse_structured_col.html">llm_parse_structured_col</a></span><span class="op">(</span></span>
<span>      fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"/y/0"</span><span class="op">)</span>   <span class="co"># dot/bracket or JSON Pointer</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why this helps</strong> Works when outputs arrive fenced,
with pre/post text, or when arrays sneak in. Non-scalars become
list-columns (set <code>allow_list = FALSE</code> to force scalars
only).</p>
<hr>
</div>
<div class="section level2">
<h2 id="choosing-the-mode">Choosing the mode<a class="anchor" aria-label="anchor" href="#choosing-the-mode"></a>
</h2>
<ul>
<li>
<strong>Reporting / ETL / metrics:</strong> Schema mode; fail fast
and retry.</li>
<li>
<strong>Exploration / ad-hoc:</strong> JSON mode + recovery
parser.</li>
<li>
<strong>Cross-provider code:</strong> Always wrap provider toggles
with <code><a href="../reference/enable_structured_output.html">enable_structured_output()</a></code> and run
<code><a href="../reference/llm_parse_structured.html">llm_parse_structured()</a></code> + local validation.</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>OpenAI: Structure Output: <a href="https://platform.openai.com/docs/guides/structured-outputs" class="external-link">https://platform.openai.com/docs/guides/structured-outputs</a>
</li>
<li>Groq: Structured Outputs: <a href="https://console.groq.com/docs/structured-outputs" class="external-link">https://console.groq.com/docs/structured-outputs</a>
</li>
<li>Together: Structured Output: <a href="https://docs.together.ai/docs/json-mode" class="external-link">https://docs.together.ai/docs/json-mode</a>
</li>
<li>x.ai: Structured Output: <a href="https://docs.x.ai/docs/guides/structured-outputs" class="external-link">https://docs.x.ai/docs/guides/structured-outputs</a>
</li>
<li>DeepSeek: JSON Mode: <a href="https://api-docs.deepseek.com/guides/json_mode" class="external-link">https://api-docs.deepseek.com/guides/json_mode</a>
</li>
<li>Anthropic: Messages API, tools &amp; <code>input_schema</code>: <a href="https://docs.anthropic.com/en/api/messages#body-tool-choice" class="external-link">https://docs.anthropic.com/en/api/messages#body-tool-choice</a>
</li>
<li>Google Gemini: Structured Output: <a href="https://ai.google.dev/gemini-api/docs/structured-output" class="external-link">https://ai.google.dev/gemini-api/docs/structured-output</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ali Sanaei.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
